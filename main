local RunService = game:GetService("RunService")
local player = game.Players.LocalPlayer
local userInputService = game:GetService("UserInputService")
local runService = game:GetService("RunService")
local players = game:GetService("Players")
local espEnabled = false
local speed = 0
local dragging = false
local highlightEnabled = false
local nameHighlightEnabled = false
local highlights = {}
local nameTags = {}
local highlights2 = {}
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local espEnabled1 = false
local highlights1 = {}

local survivorsFolder
local killersFolder

local function clearNameTags()
	for _, tag in pairs(nameTags) do
		if tag then tag:Destroy() end
	end
	nameTags = {}
end

local function clearHighlights()
	for _, highlight in pairs(highlights) do
		if highlight then highlight:Destroy() end
	end
	highlights = {}
end

local function clearHighlights1()
	for _, highlight in pairs(highlights1) do
		if highlight then highlight:Destroy() end
	end
	highlights1 = {}
end

local function highlightInstances()
	clearHighlights1()
	local mapRoot = game.Workspace:FindFirstChild("Map")
	if mapRoot then
		local ingame = mapRoot:FindFirstChild("Ingame")
		if ingame then
			local map = ingame:FindFirstChild("Map")
			if map then
				for _, obj in pairs(map:GetChildren()) do
					if obj.Name == "Generator" then
						local instances = obj:FindFirstChild("Instances")
						if instances then
							local lastgen = instances:FindFirstChild("Generator")
							if lastgen and lastgen:IsA("Model") then
								local highlight = Instance.new("Highlight")
								highlight.Adornee = lastgen
								highlight.FillColor = Color3.fromRGB(255, 0, 0) -- ярко красный
								highlight.OutlineColor = Color3.new(1, 1, 1)   -- белый контур
								highlight.Parent = lastgen

								highlights1[lastgen] = highlight
							end
						end
					end
				end
			end
		end
	end
end

local function getAllBloxyColas()
	local colas = {}
	local success, map1 = pcall(function() return Workspace:WaitForChild("Map",5) end)
	if not success or not map1 then return colas end
	local success2, ingame = pcall(function() return map1:WaitForChild("Ingame",5) end)
	if not success2 or not ingame then return colas end
	local success3, map2 = pcall(function() return ingame:WaitForChild("Map",5) end)
	if not success3 or not map2 then return colas end

	for _, obj in pairs(map2:GetChildren()) do
		if obj.Name == "BloxyCola" then
			table.insert(colas, obj)
		end
	end

	return colas
end

local function clearHighlights2()
	for _, h in pairs(highlights2) do
		if h and h.Parent then
			h:Destroy()
		end
	end
	highlights2 = {}
end

local function createHighlightsForWorkspaceColas()
	for _, cola in pairs(Workspace:GetChildren()) do
		if cola.Name == "BloxyCola" then
			local function recurse(obj)
				for _, child in pairs(obj:GetChildren()) do
					if child:IsA("BasePart") then
						local h = Instance.new("Highlight")
						h.Adornee = child
						h.FillColor = Color3.fromRGB(255, 255, 0)
						h.OutlineColor = Color3.fromRGB(255, 255, 255)
						h.Parent = child
						table.insert(highlights2,  h)
					else
						recurse(child)
					end
				end
			end
			recurse(cola)
		end
	end
end

local function createHighlightsForAll()
	clearHighlights2()

	local colas = getAllBloxyColas()
	for _, cola in ipairs(colas) do
		local function recurse(obj)
			for _, child in pairs(obj:GetChildren()) do
				if child:IsA("BasePart") then
					local h = Instance.new("Highlight")
					h.Adornee = child
					h.FillColor = Color3.fromRGB(255, 255, 0)
					h.OutlineColor = Color3.fromRGB(255, 255, 255)
					h.Parent = child
					table.insert(highlights2, h)
				else
					recurse(child)
				end
			end
		end
		recurse(cola)
	end

	createHighlightsForWorkspaceColas()

end

local function toggleESP(state)
	espEnabled1 = state
	if espEnabled1 then
		createHighlightsForAll()
	else
		clearHighlights2()
	end
end

local function createNameTag(model, color)
	if nameTags[model] then return end
	if model:IsA("Model") and model:FindFirstChild("HumanoidRootPart") then
		local billboard = Instance.new("BillboardGui")
		billboard.Name = "NameTag"
		billboard.Adornee = model:FindFirstChild("HumanoidRootPart")
		billboard.Size = UDim2.new(0, 100, 0, 30)
		billboard.StudsOffset = Vector3.new(0, 2.5, 0)
		billboard.AlwaysOnTop = true
		billboard.Parent = player:WaitForChild("PlayerGui")

		local textLabel = Instance.new("TextLabel")
		textLabel.BackgroundTransparency = 1
		textLabel.Size = UDim2.new(1, 0, 1, 0)
		textLabel.Font = Enum.Font.SourceSansBold
		textLabel.TextSize = 20
		textLabel.TextColor3 = color
		textLabel.TextStrokeTransparency = 0.4
		textLabel.Text = model.Name
		textLabel.Parent = billboard

		nameTags[model] = billboard
	end
end

local function updateNameTags()
	if not nameHighlightEnabled then return end

	survivorsFolder = survivorsFolder or (workspace.Players and workspace.Players:FindFirstChild("Survivors"))
	killersFolder = killersFolder or (workspace.Players and workspace.Players:FindFirstChild("Killers"))

	if survivorsFolder then
		for _, model in pairs(survivorsFolder:GetChildren()) do
			createNameTag(model, Color3.fromRGB(0, 120, 255)) -- синий для survivors
		end
	end

	if killersFolder then
		for _, model in pairs(killersFolder:GetChildren()) do
			createNameTag(model, Color3.fromRGB(139, 0, 0)) -- темно-красный для killers
		end
	end

	-- Удаляем nameTags для моделей, которых уже нет
	for model, tag in pairs(nameTags) do
		local inSurvivors = survivorsFolder and survivorsFolder:FindFirstChild(model.Name)
		local inKillers = killersFolder and killersFolder:FindFirstChild(model.Name)
		if not inSurvivors and not inKillers then
			tag:Destroy()
			nameTags[model] = nil
		end
	end
end

local function enableNameTags()
	nameHighlightEnabled = true
	clearNameTags()
	updateNameTags()
end

local function disableNameTags()
	nameHighlightEnabled = false
	clearNameTags()
end

local function addHighlight(model, color)
	if highlights[model] then return end -- уже подсвечено
	if model:IsA("Model") and model:FindFirstChild("HumanoidRootPart") then
		local highlight = Instance.new("Highlight")
		highlight.Adornee = model
		highlight.FillColor = color
		highlight.FillTransparency = 0.5
		highlight.OutlineColor = color
		highlight.OutlineTransparency = 0
		highlight.Parent = player:WaitForChild("PlayerGui")
		highlights[model] = highlight
	end
end

local function updateHighlights()
	if not highlightEnabled then return end
	-- Добавляем подсветку для новых моделей выживших
	survivorsFolder = workspace.Players.Survivors
	killersFolder = workspace.Players.Killers
	if survivorsFolder then
		for _, model in pairs(survivorsFolder:GetChildren()) do
			addHighlight(model, Color3.fromRGB(0, 170, 255))
		end
	end

	-- Добавляем подсветку для новых моделей киллеров
	if killersFolder then
		for _, model in pairs(killersFolder:GetChildren()) do
			addHighlight(model, Color3.fromRGB(255, 0, 0))
		end
	end

	-- Удаляем подсветку для тех моделей, которых уже нет в папках
	for model, highlight in pairs(highlights) do
		if typeof(model) == "Instance" then
			local inSurvivors = survivorsFolder and survivorsFolder:FindFirstChild(model.Name)
			local inKillers = killersFolder and killersFolder:FindFirstChild(model.Name)
			if not inSurvivors and not inKillers then
				highlight:Destroy()
				highlights[model] = nil
			end
		else
			warn("Ключ highlights не является Instance:", model)
			highlights[model] = nil -- либо удалить неверный элемент
		end
	end
end

local function enableHighlights()
	highlightEnabled = true
	updateHighlights()
	
end

local function disableHighlights()
	highlightEnabled = false
	clearHighlights()
end

-- Настройка персонажа для движения

local function setupCharacter(character)
	local humanoidRootPart = character:WaitForChild("HumanoidRootPart")
	local humanoid = character:WaitForChild("Humanoid")

	runService.RenderStepped:Connect(function(dt)
		if speed > 0 then
			local moveDir = humanoid.MoveDirection
			if moveDir.Magnitude > 0 then
				local inc = moveDir.Unit * speed * dt
				humanoidRootPart.CFrame = humanoidRootPart.CFrame + inc
			end
		end
	end)
end


local screenGui = Instance.new("ScreenGui")
screenGui.Name = "SpeedControlGui"
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

local frame = Instance.new("Frame", screenGui)
frame.Size = UDim2.new(0, 350, 0, 250)
frame.Position = UDim2.new(0.5, -175, 0.5, -90)
frame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
frame.Active = true
frame.Draggable = true

local label = Instance.new("TextLabel", frame)
label.Text = "Ускорение: 0"
label.Size = UDim2.new(1, 0, 0, 30)
label.BackgroundTransparency = 1
label.TextColor3 = Color3.new(1,1,1)
label.Font = Enum.Font.SourceSansBold
label.TextSize = 22

local bar = Instance.new("Frame", frame)
bar.Size = UDim2.new(0, 290, 0, 20)
bar.Position = UDim2.new(0, 30, 0, 60)
bar.BackgroundColor3 = Color3.fromRGB(80,80,80)

local fill = Instance.new("Frame", bar)
fill.Size = UDim2.new(0, 0, 1, 0)
fill.BackgroundColor3 = Color3.fromRGB(0,170,255)

local knob = Instance.new("ImageButton", bar)
knob.Size = UDim2.new(0, 30, 0, 30)
knob.Position = UDim2.new(0, -15, 0, -5)
knob.BackgroundTransparency = 1
knob.Image = "rbxassetid://3570695787"
knob.Modal = true

local toggleHighlightLabel = Instance.new("TextLabel", frame)
toggleHighlightLabel.Size = UDim2.new(0, 200, 0, 30)
toggleHighlightLabel.Position = UDim2.new(0, 30, 0, 95)
toggleHighlightLabel.BackgroundTransparency = 1
toggleHighlightLabel.TextColor3 = Color3.new(1,1,1)
toggleHighlightLabel.Font = Enum.Font.SourceSans
toggleHighlightLabel.TextSize = 18
toggleHighlightLabel.Text = "Обводка игроков: ВЫКЛ"

local toggleHighlightCola = Instance.new("TextLabel", frame)
toggleHighlightCola.Size = UDim2.new(0, 200, 0, 30)
toggleHighlightCola.Position = UDim2.new(0, 30, 0, 200)
toggleHighlightCola.BackgroundTransparency = 1
toggleHighlightCola.TextColor3 = Color3.new(1,1,1)
toggleHighlightCola.Font = Enum.Font.SourceSans
toggleHighlightCola.TextSize = 18
toggleHighlightCola.Text = "Обводка BloxyCola: ВЫКЛ"

local toggleButtonCola = Instance.new("TextButton", frame)
toggleButtonCola.Size = UDim2.new(0, 80, 0, 30)
toggleButtonCola.Position = UDim2.new(0, 240, 0, 200)
toggleButtonCola.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
toggleButtonCola.TextColor3 = Color3.new(1,1,1)
toggleButtonCola.Font = Enum.Font.SourceSansBold
toggleButtonCola.TextSize = 18
toggleButtonCola.Text = "ВКЛ"

local toggleButton = Instance.new("TextButton", frame)
toggleButton.Size = UDim2.new(0, 80, 0, 30)
toggleButton.Position = UDim2.new(0, 240, 0, 95)
toggleButton.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
toggleButton.TextColor3 = Color3.new(1,1,1)
toggleButton.Font = Enum.Font.SourceSansBold
toggleButton.TextSize = 18
toggleButton.Text = "ВКЛ"

local toggleNameLabel = Instance.new("TextLabel", frame)
toggleNameLabel.Size = UDim2.new(0, 200, 0, 30)
toggleNameLabel.Position = UDim2.new(0, 30, 0, 130)
toggleNameLabel.BackgroundTransparency = 1
toggleNameLabel.TextColor3 = Color3.new(1,1,1)
toggleNameLabel.Font = Enum.Font.SourceSans
toggleNameLabel.TextSize = 18
toggleNameLabel.Text = "Подсветка ников: ВЫКЛ"

local toggleNameButton = Instance.new("TextButton", frame)
toggleNameButton.Size = UDim2.new(0, 80, 0, 30)
toggleNameButton.Position = UDim2.new(0, 240, 0, 130)
toggleNameButton.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
toggleNameButton.TextColor3 = Color3.new(1,1,1)
toggleNameButton.Font = Enum.Font.SourceSansBold
toggleNameButton.TextSize = 18
toggleNameButton.Text = "ВКЛ"

local toggleGENButton = Instance.new("TextButton", frame)
toggleGENButton.Size = UDim2.new(0, 80, 0, 30)
toggleGENButton.Position = UDim2.new(0, 240, 0, 165)
toggleGENButton.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
toggleGENButton.TextColor3 = Color3.new(1,1,1)
toggleGENButton.Font = Enum.Font.SourceSansBold
toggleGENButton.TextSize = 18
toggleGENButton.Text = "ВКЛ"

local toggleHighlightLabelGEN = Instance.new("TextLabel", frame)
toggleHighlightLabelGEN.Size = UDim2.new(0, 200, 0, 30)
toggleHighlightLabelGEN.Position = UDim2.new(0, 30, 0, 165)
toggleHighlightLabelGEN.BackgroundTransparency = 1
toggleHighlightLabelGEN.TextColor3 = Color3.new(1,1,1)
toggleHighlightLabelGEN.Font = Enum.Font.SourceSans
toggleHighlightLabelGEN.TextSize = 18
toggleHighlightLabelGEN.Text = "генератор есп: ВЫКЛ"

toggleButton.MouseButton1Click:Connect(function()
	if highlightEnabled then
		disableHighlights()
		toggleHighlightLabel.Text = "Обводка игроков: ВЫКЛ"
		toggleButton.Text = "ВКЛ"
	else
		toggleHighlightLabel.Text = "Обводка игроков: ВКЛ"
		enableHighlights()
		toggleButton.Text = "ВЫКЛ"
	end
end)

toggleButtonCola.MouseButton1Click:Connect(function()
	espEnabled1 = not espEnabled1
	toggleESP(espEnabled1)
	if toggleHighlightCola.Text == "Обводка BloxyCola: ВЫКЛ" then
		toggleHighlightCola.Text = "Обводка BloxyCola: ВКЛ"
	else
		toggleHighlightCola.Text = "Обводка BloxyCola: ВЫКЛ"
	end
	if toggleHighlightCola.Text == "ВКЛ" then
		toggleButtonCola.Text = "ВЫКЛ"
	else
		toggleButtonCola.Text = "ВКЛ"
	end
	toggleButtonCola.Text = "ВКЛ" or "ВЫКЛ"
end)

toggleNameButton.MouseButton1Click:Connect(function()
	if nameHighlightEnabled then
		disableNameTags()
		toggleNameLabel.Text = "Подсветка ников: ВЫКЛ"
		toggleNameButton.Text = "ВКЛ"
	else
		enableNameTags()
		toggleNameLabel.Text = "Подсветка ников: ВКЛ"
		toggleNameButton.Text = "ВЫКЛ"
	end
end)

toggleGENButton.MouseButton1Click:Connect(function()
	espEnabled = not espEnabled
	if espEnabled then
		toggleHighlightLabelGEN.Text = "генератор есп: ВКЛ"
		toggleGENButton.Text = "ВЫКЛ"
		highlightInstances()
	else
		toggleHighlightLabelGEN.Text = "генератор есп: ВЫКЛ"
		toggleGENButton.Text = "ВКЛ"
		clearHighlights1()
	end
end)

knob.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then
		dragging = true
	end
end)

userInputService.InputChanged:Connect(function(input)
	if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
		local relativeX = math.clamp(input.Position.X - bar.AbsolutePosition.X, 0, bar.AbsoluteSize.X)
		local percent = relativeX / bar.AbsoluteSize.X
		speed = math.floor(percent * 100 + 0.5)

		fill.Size = UDim2.new(percent, 0, 1, 0)
		knob.Position = UDim2.new(percent, -15, 0, -5)
		label.Text = "Ускорение: "..speed
	end
end)

userInputService.InputEnded:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then
		dragging = false
	end
end)

if player.Character then
	setupCharacter(player.Character)
end

player.CharacterAdded:Connect(function(char)
	setupCharacter(char)
end)

RunService.Heartbeat:Connect(function()
	if highlightEnabled then
		updateHighlights()
	end
	if nameHighlightEnabled then
		updateNameTags()
	end
	if espEnabled1 then
		createHighlightsForAll()
	end
end)
